<!-- ------------------------------------------------------------------------------------------------------------
     ------------------------------------- INICIO informe_alumno .HTML ------------------------------------------
     ------------------------------------------------------------------------------------------------------------ -->

{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Informes</title>
<link rel="icon" type="image/png" href="{% static 'assets/imagenes/logo1.png' %}">
  <!--arreglar el css de este apartado-->
<link rel="stylesheet" href="{% static 'assets/css/informe_alumno.css' %}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<!-- TITULO BODY -->
<body>

  <!-- TITULO BARRA LATERAL -->

      <!--clase de la barra lateral-->
      <nav class="sidebar">
        <div class="profile text-center p-3">
          {% if foto %}
            <img src="data:image/jpeg;base64,{{ foto }}" alt="Perfil">
          {% else %}
            <img src="https://i.pinimg.com/736x/f6/d5/b4/f6d5b458bf7aa0276c81a666c916de18.jpg" alt="Perfil">
          {% endif %}
          <h5 class="text-white">{{ nombre }} {{ apellido }}</h5>
        </div>
        <ul class="nav flex-column">
          <li><a href="{% url 'inicio_alumno' %}" class="nav-link {% if request.resolver_match.url_name == 'inicio_alumno' %}active{% endif %}"><i class="fas fa-home me-2"></i>Inicio</a></li>
          <li><a href="{% url 'perfil_alumno' %}" class="nav-link {% if request.resolver_match.url_name == 'perfil_alumno' %}active{% endif %}"><i class="fas fa-user me-2"></i>Perfil</a></li>
          <li><a href="{% url 'test_interest_alumno' %}" class="nav-link {% if request.resolver_match.url_name == 'test_interest_alumno' %}active{% endif %}"><i class="fas fa-list-check me-2"></i>Test de Inter√©s</a></li>
          <li><a href="{% url 'informe_alumno' %}" class="nav-link {% if request.resolver_match.url_name == 'informe_alumno' %}active{% endif %}"><i class="fas fa-file-alt me-2"></i>Informes</a></li>
          <li><a href="{% url 'estadisticas_asignatura_alumno' %}" class="nav-link {% if request.resolver_match.url_name == 'estadisticas_asignatura_alumno' %}active{% endif %}"><i class="fas fa-chart-bar me-2"></i>Estad√≠sticas Asignatura</a></li>
          <li><a href="{% url 'retroalimentacion_alumno' %}" class="nav-link {% if request.resolver_match.url_name == 'retroalimentacion_alumno' %}active{% endif %}"><i class="fas fa-file-alt me-2"></i>Mis Retroalimentaciones</a></li>
          <li>
            <a href="#" id="btnCerrarSesion" class="nav-link text-white">
              <i class="fas fa-right-to-bracket me-2"></i>Salir
            </a>
          </li>
        </ul>
      </nav>      

  <!-- TITULO DE INFORMES -->   
   
      <!--apartado de informes-->
      <div class="content">
        <div class="topbar">
          <h4>Informes Generados</h4>
        </div>

        <p>Genera informes personalizados con inteligencia artificial seg√∫n tus datos acad√©micos e intereses. 
          Revisa el historial de an√°lisis realizados para seguir tu evoluci√≥n. 
          Estas herramientas te ofrecen una visi√≥n clara de tu progreso y proyecci√≥n profesional.</p>

  <!-- NAV DE PESTA√ëAS -->
  <ul class="nav ia-tabs mt-4" id="tabAnalisis">
    <li class="nav-item">
      <button class="ia-tab-link active" id="tab-crear" data-bs-toggle="tab" data-bs-target="#crear" type="button">
        <i class="fas fa-brain me-2"></i>Crear An√°lisis
      </button>
    </li>
    <li class="nav-item">
      <button class="ia-tab-link" id="tab-historial" data-bs-toggle="tab" data-bs-target="#historial" type="button">
        <i class="fas fa-file-alt me-2"></i>Historial de An√°lisis
      </button>
    </li>
  </ul>

  <div class="tab-content mt-3">

    <!-- üß† TAB 1: CREAR AN√ÅLISIS -->
    <div class="tab-pane fade show active" id="crear" role="tabpanel">
      <div class="card p-4">
        <h5>üîç An√°lisis de IA</h5>
        <div class="botones-ia">
          <button id="btnPruebaIAFree" class="btn btn-secondary">
            <i class="fas fa-robot me-2"></i>Ejecutar IA
          </button>
          <button id="btnGuardarPDF" class="btn btn-success ms-2" disabled>
            <i class="fas fa-save me-2"></i>Guardar Informe como PDF
          </button>
        </div>
        <pre id="outputIAFree" class="mt-3"></pre>
        <div id="iaResult" class="ia-result-container mt-4"></div>
      </div>
    </div>

    <!-- üìú TAB 2: HISTORIAL -->
    <div class="tab-pane fade" id="historial" role="tabpanel">
      <div class="card mt-4 p-4">
        <h5>Historial de An√°lisis</h5>
        {% if reportes %}
          <table class="table table-striped mt-3 align-middle text-center">
            <thead class="table-primary">
              <tr>
                <th>Nombre del Informe</th>
                <th>Fecha de Generaci√≥n</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for rep in reportes %}
                <tr>
                  <td>{{ rep.nombre_reporte|default:"Informe.pdf" }}</td>
                  <td>{{ rep.fecha_generado|default:""|slice:":19" }}</td>
                  <td>
                    <button class="btn btn-color1 btn-sm ver-pdf-btn"
                            data-base64="{{ rep.ruta_contenido }}"
                            data-nombre="{{ rep.nombre_reporte|default:'Informe.pdf' }}">
                      <i class="fas fa-eye"></i> Ver
                    </button>
                    <a href="data:application/pdf;base64,{{ rep.ruta_contenido }}"
                       download="{{ rep.nombre_reporte|default:'Informe.pdf' }}"
                       class="btn btn-color2 btn-sm ms-2">
                      <i class="fas fa-download"></i> Descargar
                    </a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="text-muted mt-2">A√∫n no has generado ning√∫n informe.</p>
        {% endif %}
      </div>

      <!-- MODAL VISUALIZAR PDF -->
      <div class="modal fade" id="verPdfModal" tabindex="-1" aria-labelledby="verPdfModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="verPdfModalLabel">Visualizar Informe</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <iframe id="pdfViewer" width="100%" height="600px" style="border:none;"></iframe>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL DE LOADER BLOQUEANTE -->
  <div class="modal fade" id="loaderModalIA" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4">
        <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <h5 class="mt-3">Analizando datos con IA...</h5>
        <p class="text-muted">Esto puede tardar unos segundos.</p>
      </div>
    </div>
  </div>

</div>
      

<!--cerrar sesion -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const btnCerrarSesion = document.getElementById("btnCerrarSesion");

  btnCerrarSesion.addEventListener("click", (e) => {
    e.preventDefault(); // evita la redirecci√≥n inmediata

    Swal.fire({
      title: "¬øDeseas cerrar sesi√≥n?",
      text: "Si cierras sesi√≥n, deber√°s volver a iniciar sesi√≥n para continuar.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "S√≠, cerrar sesi√≥n",
      cancelButtonText: "Cancelar",
      confirmButtonColor: "#d43939",
      cancelButtonColor: "#d1b0e9",
      reverseButtons: true,
      allowOutsideClick: false
    }).then((result) => {
      if (result.isConfirmed) {
        // Redirige solo si confirma
        window.location.href = "{% url 'Inicio' %}";
      }
    });
  });
});
</script>


      <!--para analizar la IA y subir los pdfs-->
      <script>
document.getElementById("btnPruebaIAFree").addEventListener("click", async () => {
  const btn = document.getElementById("btnPruebaIAFree");
  const out = document.getElementById("outputIAFree");
  const loaderModal = new bootstrap.Modal(document.getElementById("loaderModalIA"));
  btn.disabled = true;
  btn.innerText = "Analizando...";

  try {
    loaderModal.show();
    const res = await fetch("{% url 'analizar_perfil_ia_free' %}", {
      method: "POST",
      headers: { "X-CSRFToken": "{{ csrf_token }}" }
    });
    const data = await res.json();

    if (data.success) {
      out.textContent = JSON.stringify(data.analisis, null, 2);
      renderAnalisisIA(data.analisis);
      document.getElementById("btnGuardarPDF").disabled = false;
      Swal.fire("‚úÖ An√°lisis completado", "El an√°lisis de IA se gener√≥ exitosamente.", "success");
    } else {
      out.textContent = "üî¥ Error: " + (data.error || "desconocido");
      Swal.fire("‚ùå Error", data.error || "Error desconocido al analizar con IA.", "error");
    }
  } catch (err) {
    console.error(err);
    Swal.fire("‚ùå Error", "No se pudo conectar con el servidor.", "error");
  } finally {
    loaderModal.hide();
    btn.disabled = false;
    btn.innerText = "Ejecutar IA";
  }
});

      async function generarPdfBase64DesdeElemento(element, options = {}) {
        const scale = options.scaleReduction || 0.8;
        const imageQuality = options.imageQuality || 0.7;

        // A√±adir encabezado con informaci√≥n del estudiante y fecha
        const nombreEstudiante = "{{ nombre }} {{ apellido }}";
        const fechaActual = new Date().toLocaleDateString("es-CL");

        // Clonar contenido del an√°lisis para evitar modificar el DOM real
        const clone = element.cloneNode(true);

        // Crear contenedor temporal para darle estilo
        const wrapper = document.createElement("div");
        wrapper.style.padding = "30px";
        wrapper.style.fontFamily = "Arial, sans-serif";
        wrapper.style.lineHeight = "1.5";
        wrapper.innerHTML = `
          <h2 style="text-align:center; color:#003366;">üìò Informe de An√°lisis Acad√©mico</h2>
          <p style="text-align:center;">${nombreEstudiante} ‚Äî ${fechaActual}</p>
          <hr style="margin: 20px 0; border:1px solid #003366;">
          ${clone.outerHTML}
        `;

        document.body.appendChild(wrapper);
        const canvas = await html2canvas(wrapper, {
          scale: window.devicePixelRatio * scale,
          useCORS: true,
          logging: false
        });
        document.body.removeChild(wrapper);

        const imgData = canvas.toDataURL('image/jpeg', imageQuality);
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'pt', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const imgProps = pdf.getImageProperties(imgData);
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);

        const blob = pdf.output('blob');
        return await blobToBase64(blob);
      }

      function blobToBase64(blob) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => {
            // reader.result = data:<mime>;base64,.... -> quitar prefijo
            const s = reader.result;
            const comma = s.indexOf(',');
            if (comma >= 0) resolve(s.slice(comma+1));
            else resolve(s);
          };
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      }

      // Evento para guardar pdf en BD
      document.getElementById("btnGuardarPDF").addEventListener("click", async () => {
        const btn = document.getElementById("btnGuardarPDF");
        btn.disabled = true;
        btn.innerText = "Guardando...";
        try {
          const element = document.getElementById("iaResult");
          if (!element || element.innerText.trim() === "") {
            Swal.fire("Aviso", "No hay contenido para guardar. Ejecuta primero el an√°lisis.", "info");
            btn.disabled = false;
            btn.innerText = "Guardar Informe como PDF";
            return;
          }

          // Generar PDF en base64 (JPEG dentro de pdf para reducir tama√±o)
          // Ajusta scaleReduction y imageQuality si a√∫n queda muy grande
          const pdfBase64 = await generarPdfBase64DesdeElemento(element, { scaleReduction: 0.8, imageQuality: 0.7 });

          // Enviar JSON (evita multipart/form-data que provoca parseo multipart y puede disparar RequestDataTooBig)
          const payload = {
            pdfBase64,
            nombreReporte: null   // el backend generar√° nombre con nombre+apellido+fecha+uuid
          };

          const res = await fetch("{% url 'guardar_reporte_pdf' %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify(payload)
          });

          // importante: si la respuesta no es json, mostrar error
          const text = await res.text();
          let data;
          try {
            data = JSON.parse(text);
          } catch (e) {
            console.error("Respuesta no JSON:", text);
            throw new Error("Respuesta inv√°lida del servidor al guardar PDF.");
          }

          if (res.ok && data.success) {
            Swal.fire("‚úÖ Guardado", "El informe se guard√≥ correctamente en la base de datos.", "success");
            // opcional: mostrar enlace para ver o descargar (si lo deseas implementar)
            // üîÑ Recargar tabla de informes autom√°ticamente
            setTimeout(() => {
              location.reload();
            }, 1500);
          } else {
            Swal.fire("‚ùå Error", data.error || "No se pudo guardar el informe.", "error");
          }

        } catch (err) {
          console.error("Error guardando PDF:", err);
          Swal.fire("‚ùå Error", "Ocurri√≥ un problema: " + (err.message || err), "error");
        } finally {
          btn.disabled = false;
          btn.innerText = "Guardar Informe como PDF";
        }
      });
      </script>

      <!--para visualizar los pdfs-->
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
      <script>
        // Mostrar modal con PDF base64
        document.addEventListener("DOMContentLoaded", function () {
          const verBtns = document.querySelectorAll(".ver-pdf-btn");
          const pdfViewer = document.getElementById("pdfViewer");

          verBtns.forEach(btn => {
            btn.addEventListener("click", () => {
              const base64Data = btn.getAttribute("data-base64");
              const nombreArchivo = btn.getAttribute("data-nombre") || "Informe.pdf";
              const pdfUrl = `data:application/pdf;base64,${base64Data}`;

              pdfViewer.src = pdfUrl;
              document.getElementById("verPdfModalLabel").innerText = nombreArchivo;

              const modal = new bootstrap.Modal(document.getElementById("verPdfModal"));
              modal.show();
            });
          });
        });
      </script>
      <!--llamado al js de informe_alumno-->
      <script src="{% static 'assets/js/informe_alumno.js' %}"></script>
      
      <!--mensajes emergentes-->
    {% if messages %}
      {% for message in messages %}
      <script>
          Swal.fire({
              icon: "{% if message.tags == 'error' %}error{% elif message.tags == 'success' %}success{% elif message.tags == 'warning' %}warning{% else %}info{% endif %}",
              title: "{{ message|escapejs }}",
              confirmButtonText: "Aceptar",
              confirmButtonColor: "#d1b0e9",
              timer: 4000,
              timerProgressBar: true
          });
      </script>
      {% endfor %}
    {% endif %}

</body>
</html>

<!-- ------------------------------------------------------------------------------------------------------------
     ------------------------------------- FIN informe_alumno .HTML ---------------------------------------------
     ------------------------------------------------------------------------------------------------------------ -->
