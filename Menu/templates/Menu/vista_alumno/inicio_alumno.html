<!-- ------------------------------------------------------------------------------------------------------------
     ------------------------------------- INICIO inicio_alumno .HTML -------------------------------------------
     ------------------------------------------------------------------------------------------------------------ -->

{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inicio</title>
  <link rel="icon" type="image/png" href="{% static 'assets/imagenes/logo1.png' %}">
  <link rel="stylesheet" href="{% static 'assets/css/inicio_alumno.css' %}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<!-- TITULO BODY -->
<body>
  <!-- TITULO BARRA LATERAL -->

      <!--clase de la barra lateral-->
      <nav class="sidebar">
        <div class="profile text-center p-3">
          {% if foto %}
            <img src="data:image/jpeg;base64,{{ foto }}" alt="Perfil">
          {% else %}
            <img src="https://i.pinimg.com/736x/f6/d5/b4/f6d5b458bf7aa0276c81a666c916de18.jpg" alt="Perfil">
          {% endif %}
          <h5 class="text-white">{{ nombre }} {{ apellido }}</h5>
        </div>
        <ul class="nav flex-column">
          <li><a href="{% url 'inicio_alumno' %}" class="nav-link {% if request.resolver_match.url_name == 'inicio_alumno' %}active{% endif %}"><i class="fas fa-home me-2"></i>Inicio</a></li>
          <li><a href="{% url 'perfil_alumno' %}" class="nav-link {% if request.resolver_match.url_name == 'perfil_alumno' %}active{% endif %}"><i class="fas fa-user me-2"></i>Perfil</a></li>
          <li><a href="{% url 'test_interest_alumno' %}" class="nav-link {% if request.resolver_match.url_name == 'test_interest_alumno' %}active{% endif %}"><i class="fas fa-list-check me-2"></i>Test de Inter√©s</a></li>
          <li><a href="{% url 'informe_alumno' %}" class="nav-link {% if request.resolver_match.url_name == 'informe_alumno' %}active{% endif %}"><i class="fas fa-file-alt me-2"></i>Informes</a></li>
          <li><a href="{% url 'estadisticas_asignatura_alumno' %}" class="nav-link {% if request.resolver_match.url_name == 'estadisticas_asignatura_alumno' %}active{% endif %}"><i class="fas fa-chart-bar me-2"></i>Estad√≠sticas Asignatura</a></li>
          <li><a href="{% url 'retroalimentacion_alumno' %}" class="nav-link {% if request.resolver_match.url_name == 'retroalimentacion_alumno' %}active{% endif %}"><i class="fas fa-file-alt me-2"></i>Mis Retroalimentaciones</a></li>
          <li>
            <a href="#" id="btnCerrarSesion" class="nav-link text-white">
              <i class="fas fa-right-to-bracket me-2"></i>Salir
            </a>
          </li>
        </ul>
      </nav>          

  <!--TITULO BIENVENIDA-->

      <div class="content">
        <div class="topbar">
          <h4>Bienvenido, {{ nombre }} {{ apellido }}</h4> 
        </div>
          <p>Este es tu panel principal. 
            Aqu√≠ puedes subir tu informe de notas para visualizar estad√≠sticas acad√©micas detalladas, 
            realizar el test de inter√©s vocacional y gestionar tus certificados. 
            Todo est√° dise√±ado para facilitar tu experiencia y acompa√±arte en tu desarrollo educativo.</p>

  <!-- NAV DE PESTA√ëAS -->
  <ul class="nav ia-tabs mt-4" id="tabCertificados">
    <li class="nav-item">
      <button class="ia-tab-link active" id="tab-subir" data-bs-toggle="tab" data-bs-target="#subir" type="button">
        <i class="fas fa-upload me-2"></i>Subir Certificados
      </button>
    </li>
    <li class="nav-item">
      <button class="ia-tab-link" id="tab-historial" data-bs-toggle="tab" data-bs-target="#historial" type="button">
        <i class="fas fa-file-alt me-2"></i>Historial Certificados
      </button>
    </li>
  </ul>

  <div class="tab-content mt-3">
    <!-- üß† PESTA√ëA SUBIR CERTIFICADOS -->
    <div class="tab-pane fade show active" id="subir" role="tabpanel">
      <div class="card p-4">
        <h5>Subir Informe PDF</h5>
        <form method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="mb-3">
            <label for="pdfFile" class="form-label">Selecciona un archivo PDF:</label>
            <input type="file" class="form-control" id="pdfFile" name="pdfFile" accept="application/pdf">
          </div>
          <button type="submit" class="btn btn-primary-custom">
            <i class="fas fa-upload"></i> Subir
          </button>
        </form>
      </div>

      <!-- BOT√ìN ANALIZAR -->
      <div class="mt-4">
        <button id="procesarPdfBtn" class="btn btn-success">
          üß† Analizar Certificado
        </button>
      </div>

      <div id="resultadoMensaje" class="mt-3"></div>

      <!-- SECCI√ìN ASIGNATURAS DETECTADAS -->
      <div id="seccionAsignaturas" class="mt-3" style="display: none;">
        <h5>Asignaturas detectadas:</h5>
        <table class="table table-bordered mt-2">
          <thead>
            <tr>
              <th class="cabecera-asignaturas">Sigla</th>
              <th class="cabecera-asignaturas">Nombre Asignatura</th>
              <th class="cabecera-asignaturas">Nota</th>
              <th class="cabecera-asignaturas">Semestre</th>
              <th class="cabecera-asignaturas">A√±o</th>
            </tr>
          </thead>
          <tbody id="tablaResultados"></tbody>
        </table>
      </div>
    </div>

    <!-- üìú PESTA√ëA HISTORIAL CERTIFICADOS -->
    <div class="tab-pane fade" id="historial" role="tabpanel">
      <div class="card mt-4 p-4">
        <h5>Informes Subidos</h5>

        {% if pdfs %}
          <table class="table table-striped mt-3 align-middle text-center">
            <thead class="table-primary">
              <tr>
                <th class="color-cabecera">Nombre del Archivo</th>
                <th class="color-cabecera">Fecha de Subida</th>
                <th class="color-cabecera">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for pdf in pdfs %}
                <tr>
                  <td>{{ pdf.nombre_archivo|default:"Informe.pdf" }}</td>
                  <td>{{ pdf.fecha_subida }}</td>
                  <td>
                    <!-- Bot√≥n visualizar -->
                    <button class="btn btn-color1 ver-pdf-btn"
                            data-base64="{{ pdf.ruta_archivo }}"
                            data-nombre="{{ pdf.nombre_archivo|default:'Informe.pdf' }}">
                      <i class="fas fa-eye"></i> Ver
                    </button>

                    <!-- Bot√≥n descargar -->
                    <a href="data:application/pdf;base64,{{ pdf.ruta_archivo }}"
                       download="{{ pdf.nombre_archivo|default:'Informe.pdf' }}"
                       class="btn btn-color2 ms-2">
                      <i class="fas fa-download"></i> Descargar
                    </a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="text-muted mt-2">A√∫n no has subido ning√∫n informe.</p>
        {% endif %}
      </div>

      <!-- MODAL PARA VISUALIZAR PDF -->
      <div class="modal fade" id="verPdfModal" tabindex="-1" aria-labelledby="verPdfModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="verPdfModalLabel">Visualizar Informe</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
              <iframe id="pdfViewer" src="" width="100%" height="600px" style="border:none;"></iframe>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- === MODAL DE CARGA === -->
  <div class="modal fade" id="loaderModal" tabindex="-1" aria-labelledby="loaderModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4">
        <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <h5 class="mt-3">Procesando tu certificado...</h5>
        <p class="text-muted mb-0">Por favor espera unos segundos mientras analizamos tu PDF.</p>
      </div>
    </div>
  </div>

  <!--cerrar sesion -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const btnCerrarSesion = document.getElementById("btnCerrarSesion");

  btnCerrarSesion.addEventListener("click", (e) => {
    e.preventDefault(); // evita la redirecci√≥n inmediata

    Swal.fire({
      title: "¬øDeseas cerrar sesi√≥n?",
      text: "Si cierras sesi√≥n, deber√°s volver a iniciar sesi√≥n para continuar.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "S√≠, cerrar sesi√≥n",
      cancelButtonText: "Cancelar",
      confirmButtonColor: "#d43939",
      cancelButtonColor: "#d1b0e9",
      reverseButtons: true,
      allowOutsideClick: false
    }).then((result) => {
      if (result.isConfirmed) {
        // Redirige solo si confirma
        window.location.href = "{% url 'Inicio' %}";
      }
    });
  });
});
</script>

      <!-- === SISTEMA DE LECTURA Y PROCESAMIENTO DE PDF === -->
      <script>
        document.getElementById("procesarPdfBtn").addEventListener("click", async () => {
          const loaderModal = new bootstrap.Modal(document.getElementById("loaderModal"));
          const seccionAsignaturas = document.getElementById("seccionAsignaturas");
          const tabla = document.getElementById("tablaResultados");

          try {
            // Mostrar loader modal
            loaderModal.show();

            // Ejecutar procesamiento
            const response = await fetch("{% url 'procesar_y_guardar_pdf' %}");
            const data = await response.json();

            // Limpiar tabla
            tabla.innerHTML = "";

            // Si hay error, mostrar alerta y ocultar loader
            if (data.error) {
              loaderModal.hide();
              Swal.fire("Error", data.error, "error");
              return;
            }

            // Si no hay datos v√°lidos
            if (!data.data || data.data.length === 0) {
              loaderModal.hide();
              Swal.fire("Atenci√≥n", "No se detectaron asignaturas en el PDF.", "warning");
              return;
            }

            // Poblar tabla
            data.data.forEach(item => {
              const fila = `
                <tr>
                  <td>${item.sigla}</td>
                  <td>${item.nombre_asignatura}</td>
                  <td>${item.nota}</td>
                  <td>${item.semestre}</td>
                  <td>${item.anio}</td>
                </tr>`;
              tabla.innerHTML += fila;
            });

            // Mostrar secci√≥n con animaci√≥n sutil
            seccionAsignaturas.style.display = "block";
            seccionAsignaturas.classList.add("fade-in");

            // Ocultar loader y mostrar √©xito
            loaderModal.hide();
            Swal.fire("Resultado", data.mensaje, "success");

          } catch (err) {
            console.error("Error al procesar y guardar PDF:", err);
            loaderModal.hide();
            Swal.fire("Error", "No se pudo procesar ni guardar el PDF.", "error");
          }
        });
      </script>
      
    <!--llamado al js de inicio_alumno-->
    <script src="{% static 'assets/js/inicio_alumno.js' %}"></script>
    
        <!-- Script para descargar PDF desde Base64 -->
    <script>
    function descargarPDF(base64Data, nombreArchivo) {
        const link = document.createElement('a');
        link.href = 'data:application/pdf;base64,' + base64Data;
        link.download = nombreArchivo;
        link.click();
    }
    </script>

     <!-- 1) Cargar Bootstrap JS (IMPORTANTE - antes del script que lo usa) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

     <!-- 2) Tu script que utiliza `bootstrap` -->
    <script>
      // Modal para visualizar PDF
      document.addEventListener("DOMContentLoaded", function () {
        const verBtns = document.querySelectorAll(".ver-pdf-btn");
        const pdfViewer = document.getElementById("pdfViewer");

        if (!pdfViewer) return; // Previene error si no existe

        verBtns.forEach(btn => {
          btn.addEventListener("click", () => {
            const base64Data = btn.getAttribute("data-base64");
            const nombreArchivo = btn.getAttribute("data-nombre") || "Informe.pdf";
            const pdfUrl = `data:application/pdf;base64,${base64Data}`;

            pdfViewer.src = pdfUrl;
            document.getElementById("verPdfModalLabel").innerText = nombreArchivo;

            const modal = new bootstrap.Modal(document.getElementById("verPdfModal"));
            modal.show();
          });
        });
      });
    </script>

    <!--mensajes emergentes-->
    {% if messages %}
      {% for message in messages %}
      <script>
          Swal.fire({
              icon: "{% if message.tags == 'error' %}error{% elif message.tags == 'success' %}success{% elif message.tags == 'warning' %}warning{% else %}info{% endif %}",
              title: "{{ message|escapejs }}",
              confirmButtonText: "Aceptar",
              confirmButtonColor: "#d1b0e9",
              timer: 4000,
              timerProgressBar: true
          });
      </script>
      {% endfor %}
    {% endif %}

</body>
</html>
<!-- ------------------------------------------------------------------------------------------------------------
     ------------------------------------- FIN inicio_alumno .HTML ----------------------------------------------
     ------------------------------------------------------------------------------------------------------------ -->