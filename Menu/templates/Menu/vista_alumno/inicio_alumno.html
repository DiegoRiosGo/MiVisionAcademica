<!-- ------------------------------------------------------------------------------------------------------------
     ------------------------------------- INICIO inicio_alumno .HTML -------------------------------------------
     ------------------------------------------------------------------------------------------------------------ -->

{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inicio</title>
  <link rel="icon" type="image/png" href="{% static 'assets/imagenes/logo1.png' %}">
  <link rel="stylesheet" href="{% static 'assets/css/inicio_alumno.css' %}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<!-- TITULO BODY -->
<body>
  <!-- TITULO BARRA LATERAL -->

      <!--clase de la barra lateral-->
      <nav class="sidebar">
        <div class="profile text-center p-3">
          {% if foto %}
            <img src="data:image/jpeg;base64,{{ foto }}" alt="Perfil">
          {% else %}
            <img src="https://i.pinimg.com/1200x/71/e0/ee/71e0ee7eb86896b2d21afa6f3a8c8a36.jpg" alt="Perfil">
          {% endif %}
          <h5 class="text-white">{{ nombre }} {{ apellido }}</h5>
        </div>
        <ul class="nav flex-column">
          <li><a href="{% url 'inicio_alumno' %}" class="nav-link {% if request.resolver_match.url_name == 'inicio_alumno' %}active{% endif %}"><i class="fas fa-home me-2"></i>Inicio</a></li>
          <li><a href="{% url 'perfil_alumno' %}" class="nav-link {% if request.resolver_match.url_name == 'perfil_alumno' %}active{% endif %}"><i class="fas fa-user me-2"></i>Perfil</a></li>
          <li><a href="{% url 'test_interest_alumno' %}" class="nav-link {% if request.resolver_match.url_name == 'test_interest_alumno' %}active{% endif %}"><i class="fas fa-list-check me-2"></i>Test de Inter√©s</a></li>
          <li><a href="{% url 'informe_alumno' %}" class="nav-link {% if request.resolver_match.url_name == 'informe_alumno' %}active{% endif %}"><i class="fas fa-file-alt me-2"></i>Informes</a></li>
          <li><a href="{% url 'estadisticas_asignatura_alumno' %}" class="nav-link {% if request.resolver_match.url_name == 'estadisticas_asignatura_alumno' %}active{% endif %}"><i class="fas fa-chart-bar me-2"></i>Estad√≠sticas Asignatura</a></li>
          <li><a href="{% url 'Inicio' %}" class="nav-link text-white"><i class="fas fa-right-to-bracket me-2"></i>Salir</a></li>
        </ul>
      </nav>          

  <!--TITULO BIENVENIDA-->

      <div class="content">
        <div class="topbar">
          <h4>Bienvenido, {{ nombre }} {{ apellido }}</h4> 
        </div>
          <p>Este es tu panel principal. Desde aqu√≠ puedes subir tu informe de notas para poder visualizar tus estad√≠sticas, 
            adem√°s de poder realizar un test de inter√©s personal y mucho m√°s.</p>

  <!-- TITULO PDF -->

        <div class="card p-4">
          <h5>Subir Informe PDF</h5>
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="mb-3">
              <label for="pdfFile" class="form-label">Selecciona un archivo PDF:</label>
              <input type="file" class="form-control" id="pdfFile" name="pdfFile" accept="application/pdf">
            </div>
            <button type="submit" class="btn btn-primary-custom">
              <i class="fas fa-upload"></i> Subir
            </button>
          </form>
        </div>

        <!-- TITULO LISTA DE INFORMES -->
        <div class="card mt-4 p-4">
          <h5>Informes Subidos</h5>

          {% if pdfs %}
            <table class="table table-striped mt-3 align-middle text-center">
              <thead class="table-primary">
                <tr>
                  <th>Nombre del Archivo</th>
                  <th>Fecha de Subida</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for pdf in pdfs %}
                  <tr>
                    <td>{{ pdf.nombre_archivo|default:"Informe.pdf" }}</td>
                    <td>{{ pdf.fecha_subida}}</td>
                    <td>
                      <!-- Bot√≥n para visualizar -->
                      <button class="btn btn-outline-primary btn-sm ver-pdf-btn" 
                              data-base64="{{ pdf.ruta_archivo }}" 
                              data-nombre="{{ pdf.nombre_archivo|default:'Informe.pdf' }}">
                        <i class="fas fa-eye"></i> Ver
                      </button>

                      <!-- Bot√≥n para descargar -->
                      <a href="data:application/pdf;base64,{{ pdf.ruta_archivo }}" 
                        download="{{ pdf.nombre_archivo|default:'Informe.pdf' }}" 
                        class="btn btn-outline-success btn-sm ms-2">
                        <i class="fas fa-download"></i> Descargar
                      </a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p class="text-muted mt-2">A√∫n no has subido ning√∫n informe.</p>
          {% endif %}
        </div>

        <!-- MODAL PARA VISUALIZAR PDF -->
        <div class="modal fade" id="verPdfModal" tabindex="-1" aria-labelledby="verPdfModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="verPdfModalLabel">Visualizar Informe</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
              </div>
              <div class="modal-body">
                <iframe id="pdfViewer" src="" width="100%" height="600px" style="border:none;"></iframe>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
              </div>
            </div>
          </div>
        </div>
      
      <!-- MODAL PARA Leer PDF -->
      <div class="mt-4">
        <button id="leerPdfBtn" class="btn btn-primary">üìÑ Leer √∫ltimo PDF</button>
      </div>

      <div class="mt-3">
        <h5>Contenido del PDF:</h5>
        <textarea id="pdfTextOutput" class="form-control" rows="10" readonly></textarea>
      </div>

      <!-- MODAL PARA escribir asignaturas por pdf -->
      <div class="mt-4">
        <button id="procesarPdfBtn" class="btn btn-success">üß† Analizar Certificado</button>
      </div>

      <div class="mt-3">
        <h5>Asignaturas detectadas:</h5>
        <table class="table table-bordered mt-2">
          <thead>
            <tr>
              <th>Sigla</th>
              <th>Nombre Asignatura</th>
              <th>Nota</th>
              <th>Semestre</th>
              <th>A√±o</th>
            </tr>
          </thead>
          <tbody id="tablaResultados"></tbody>
        </table>
      </div>

      <button id="guardarResultadosBtn" class="btn btn-success mt-3" style="display:none;">
        Guardar resultados en la base de datos
      </button>

      <div id="resultadoMensaje" class="mt-3"></div>

      <script>
      let resultadosExtraidos = []; // almacenar√° los resultados del PDF

      function procesarPDF() {
        fetch("{% url 'procesar_pdf' %}", { method: "GET" })
          .then(response => response.json())
          .then(data => {
            if (data.data) {
              resultadosExtraidos = data.data;
              mostrarResultadosEnTabla(data.data);
              document.getElementById("guardarResultadosBtn").style.display = "block";
            } else {
              alert("No se pudieron procesar los datos del PDF.");
            }
          })
          .catch(err => console.error(err));
      }

      document.getElementById("guardarResultadosBtn").addEventListener("click", () => {
        fetch("{% url 'guardar_notas_pdf' %}", {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-CSRFToken": getCookie("csrftoken") },
          body: JSON.stringify({ resultados: resultadosExtraidos })
        })
        .then(response => response.json())
        .then(data => {
          const msgDiv = document.getElementById("resultadoMensaje");
          if (data.success) {
            msgDiv.innerHTML = `<div class="alert alert-success">${data.mensaje}</div>`;
          } else {
            msgDiv.innerHTML = `<div class="alert alert-danger">${data.error || "Error al guardar."}</div>`;
          }
        })
        .catch(err => console.error("Error al guardar:", err));
      });

      // Utilidad para obtener el CSRF token
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let cookie of cookies) {
            const c = cookie.trim();
            if (c.startsWith(name + "=")) {
              cookieValue = decodeURIComponent(c.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
      </script>

      
      <script>
      document.getElementById("procesarPdfBtn").addEventListener("click", async () => {
        const response = await fetch("/procesar_pdf/");
        const data = await response.json();

        const tabla = document.getElementById("tablaResultados");
        tabla.innerHTML = "";

        if (data.error) {
          alert(data.error);
          return;
        }

        data.data.forEach(item => {
          const fila = `
            <tr>
              <td>${item.sigla}</td>
              <td>${item.nombre_asignatura}</td>
              <td>${item.nota}</td>
              <td>${item.semestre}</td>
              <td>${item.anio}</td>
            </tr>`;
          tabla.innerHTML += fila;
        });
      });
      </script>

      <script>
      document.getElementById("leerPdfBtn").addEventListener("click", async () => {
        const response = await fetch("/leer_pdf/");
        const data = await response.json();

        if (data.error) {
          alert(data.error);
        } else {
          document.getElementById("pdfTextOutput").value = data.texto;
        }
      });
      </script>




    <!--llamado al js de inicio_alumno-->
    <script src="{% static 'assets/js/inicio_alumno.js' %}"></script>
    
        <!-- Script para descargar PDF desde Base64 -->
    <script>
    function descargarPDF(base64Data, nombreArchivo) {
        const link = document.createElement('a');
        link.href = 'data:application/pdf;base64,' + base64Data;
        link.download = nombreArchivo;
        link.click();
    }
    </script>

     <!-- 1) Cargar Bootstrap JS (IMPORTANTE - antes del script que lo usa) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

     <!-- 2) Tu script que utiliza `bootstrap` -->
    <script>
      // Modal para visualizar PDF
      document.addEventListener("DOMContentLoaded", function () {
        const verBtns = document.querySelectorAll(".ver-pdf-btn");
        const pdfViewer = document.getElementById("pdfViewer");

        if (!pdfViewer) return; // Previene error si no existe

        verBtns.forEach(btn => {
          btn.addEventListener("click", () => {
            const base64Data = btn.getAttribute("data-base64");
            const nombreArchivo = btn.getAttribute("data-nombre") || "Informe.pdf";
            const pdfUrl = `data:application/pdf;base64,${base64Data}`;

            pdfViewer.src = pdfUrl;
            document.getElementById("verPdfModalLabel").innerText = nombreArchivo;

            const modal = new bootstrap.Modal(document.getElementById("verPdfModal"));
            modal.show();
          });
        });
      });
    </script>

    <!--mensajes emergentes-->
    {% if messages %}
      {% for message in messages %}
      <script>
          Swal.fire({
              icon: "{% if message.tags == 'error' %}error{% elif message.tags == 'success' %}success{% elif message.tags == 'warning' %}warning{% else %}info{% endif %}",
              title: "{{ message|escapejs }}",
              confirmButtonText: "Aceptar",
              confirmButtonColor: "#3085d6",
              timer: 4000,
              timerProgressBar: true
          });
      </script>
      {% endfor %}
    {% endif %}

</body>
</html>
<!-- ------------------------------------------------------------------------------------------------------------
     ------------------------------------- FIN inicio_alumno .HTML ----------------------------------------------
     ------------------------------------------------------------------------------------------------------------ -->